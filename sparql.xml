<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd"
       securityLevel="any"
       https="false"
       >
<!-- http://developer.yahoo.com/yql/guide/yql-opentables-reference.html -->
<meta>
  <author>Dave Beckett</author>
  <documentationURL>http://triplr.org/sparyql/</documentationURL>
  <sampleQuery>select * from {table} where query="SPARQL QUERY" and service="SPARQL ENDPOINT URL" e.g.
select * from {table} where query="PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt; SELECT $nick $name FROM &lt;http://www.dajobe.org/foaf.rdf&gt; WHERE { $x a foaf:Person . $x foaf:nick $nick . $x foaf:name $name }" and service="http://sparql.org/sparql"
  </sampleQuery>
</meta>
<bindings>
  <select produces="XML"> 
    <!--
        SPARQL Protocol http://www.w3.org/TR/rdf-sparql-protocol/
        HTTP binding:
	{ endpoint} ?query={query} & default-graph-uri={uri}

        Requires/assumes application/sparql-results+xml response.
    -->
    <inputs>
      <key id='query'   type='xs:string' paramType='variable' required='true' />
      <key id='service' type='xs:uri'    paramType='variable' required='true' />
    </inputs>


<!--
headers: {"x-joseki-server":"Joseki-3.4.1-SNAPSHOT","x-cache":"MISS from yqlcache1.pipes.sp1.yahoo.com","via":"1.0 yqlcache1.pipes.sp1.yahoo.com:3128 (squid/2.7.STABLE6)","content-type":"application/sparql-results+xml","age":"2","x-cache-lookup":"MISS from yqlcache1.pipes.sp1.yahoo.com:3128","cache-control":"no-cache","pragma":"no-cache","vary":"YahooTransform","server":"YTS/1.17.17","date":"Thu, 08 Oct 2009 02:11:45 GMT","transfer-encoding":"chunked"}.
-->

    <execute>
    <![CDATA[
url = unescape(service) + "?query=" + escape(query);
url = 'http://triplr.org/static/output.srx';
var resp = y.rest(url).accept("application/sparql-results+xml").get();
var data = resp.response;
var ct   = resp.headers['content-type'];

default xml namespace = ''; 
var sparqlns = new Namespace('http://www.w3.org/2005/sparql-results#'); 

var xdata = <sparql>{data}</sparql>;

var results = <sparql/>;
for each (var result in xdata.sparqlns::sparql.sparqlns::results.children()) {
  var row = <result/>;
  for each (var binding in result.children()) {
    var b = <{binding.@name}/>;
    b.appendChild(binding.children());
    row.appendChild(b);
  }
  results.sparql += row;
}
response.object = results;
  ]]>
    </execute>
  </select>
</bindings>

</table>
